name: Create and Publish Release

on:
  push:
    branches: [ main ]
    paths:
      - version.json

jobs:
  # ===================================================================
  # BUILD ON UBUNTU 20.04 (FOR WIDE COMPATIBILITY)
  # ===================================================================
  build-compatible:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies in Container
        run: |
          apt-get update
          apt-get install -y --no-install-recommends git jq build-essential ca-certificates
          
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Read version
        run: echo "VERSION=$(jq -r .version version.json)" >> $GITHUB_ENV

      - name: Inject version into Go source
        run: |
          sed -i "s/^const version = .*$/const version = \"${{ env.VERSION }}\"/" btxz/main.go
          
      - name: Build cross-platform binaries (Compatible)
        run: |
          chmod +x scripts/build.sh
          scripts/build.sh ${{ env.VERSION }} compat

      - name: Upload compatible artifacts
        uses: actions/upload-artifact@v4
        with:
          name: compatible-binaries
          path: artifacts/

  # ===================================================================
  # BUILD ON UBUNTU 22.04 (FOR MODERN SYSTEMS)
  # ===================================================================
  build-modern:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Read version
        run: echo "VERSION=$(jq -r .version version.json)" >> $GITHUB_ENV

      - name: Inject version into Go source
        run: |
          sed -i "s/^const version = .*$/const version = \"${{ env.VERSION }}\"/" btxz/main.go

      - name: Build cross-platform binaries (Modern)
        run: |
          chmod +x scripts/build.sh
          scripts/build.sh ${{ env.VERSION }} modern

      - name: Upload modern artifacts
        uses: actions/upload-artifact@v4
        with:
          name: modern-binaries
          path: artifacts/

  # ===================================================================
  # COLLECT BINARIES, CREATE RELEASE, AND UPDATE JSON
  # ===================================================================
  release:
    needs: [build-compatible, build-modern]
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for creating releases and pushing changes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main # Explicitly checkout main to allow pushing later

      - name: Read Metadata from version.json
        id: meta
        run: |
          # Extract Version and Title
          VERSION=$(jq -r .version version.json)
          TITLE=$(jq -r .title version.json)
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "RELEASE_TITLE=$TITLE" >> $GITHUB_ENV
          
          # Extract Multiline Markdown Message safely using EOF
          echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
          jq -r .message version.json >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: combined-artifacts
          merge-multiple: true 
          
      - name: Organize Artifacts & Checksums
        run: |
          mkdir -p artifacts
          # Move all downloaded binaries into the artifacts folder
          mv combined-artifacts/* artifacts/
          
          # Generate checksums
          chmod +x scripts/generate-checksums.sh
          scripts/generate-checksums.sh
          
          # Debug: Show files to ensure they exist
          ls -l artifacts/

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ env.VERSION }}"
          name: "${{ env.RELEASE_TITLE }}" # Uses title from JSON
          body: "${{ env.RELEASE_BODY }}"   # Uses markdown message from JSON
          files: |
            artifacts/*
            scripts/install.sh
            scripts/install.ps1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Update version.json with secure metadata
        env:
          ASSETS_JSON: ${{ steps.create_release.outputs.assets }}
        run: |
          # Pass asset data to python script
          python3 scripts/update_manifest.py version.json "$ASSETS_JSON" artifacts/
          
          # Print for verification
          echo "Updated version.json content:"
          cat version.json

      - name: Commit and push updated version.json
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Ensure we are on main
          git checkout main

          git checkout -- scripts/generate-checksums.sh || true

          # Stage version.json
          git add version.json
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore(release): Update asset URLs for v${{ env.VERSION }} [skip ci]"
            
            git pull origin main --rebase
            
            git push origin main
          fi
